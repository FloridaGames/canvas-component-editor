<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanvasLMS Component Editor</title>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill.js assets -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <style>
        /* Basic styles for the editor experience */
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; padding: 2rem; }
        .loader {
            width: 20px; height: 20px; border: 3px solid #e9ecef;
            border-top-color: #007bff; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Canvas-compatible Grid System */
        .grid-row { display: flex; flex-wrap: wrap; margin-right: -15px; margin-left: -15px; }
        .col-xs-12, .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
            position: relative;
            width: 100%;
            padding-right: 15px;
            padding-left: 15px;
            box-sizing: border-box;
        }
        @media (min-width: 768px) {
            .col-md-1 { flex: 0 0 8.333333%; max-width: 8.333333%; }
            .col-md-2 { flex: 0 0 16.666667%; max-width: 16.666667%; }
            .col-md-3 { flex: 0 0 25%; max-width: 25%; }
            .col-md-4 { flex: 0 0 33.333333%; max-width: 33.333333%; }
            .col-md-5 { flex: 0 0 41.666667%; max-width: 41.666667%; }
            .col-md-6 { flex: 0 0 50%; max-width: 50%; }
            .col-md-7 { flex: 0 0 58.333333%; max-width: 58.333333%; }
            .col-md-8 { flex: 0 0 66.666667%; max-width: 66.666667%; }
            .col-md-9 { flex: 0 0 75%; max-width: 75%; }
            .col-md-10 { flex: 0 0 83.333333%; max-width: 83.333333%; }
            .col-md-11 { flex: 0 0 91.666667%; max-width: 91.666667%; }
            .col-md-12 { flex: 0 0 100%; max-width: 100%; }
        }

        /* Component Controls */
        .component-wrapper {
            position: relative;
            padding: 2px;
            border: 1px solid #dee2e6;
            margin-bottom: 1rem;
             padding-top: 40px; /* Make space for the toolbar */
        }
        .component-controls {
            display: flex;
            position: absolute;
            top: 0.5rem;
            left: -2.75rem;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 0.25rem;
            z-index: 20;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        /* Layout Block Styles */
        .component-column {
            min-height: 100px;
            border: 2px dashed #e0e0e0;
            padding: 1rem;
            background-color: #fdfdfd;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: left;
            width: 90%; max-width: 600px;
        }
        .modal-button {
            background-color: #007bff; color: white; font-weight: bold; padding: 0.75rem 1.5rem;
            border-radius: 8px; border: none; cursor: pointer; margin: 0.5rem;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .modal-button:hover { background-color: #0056b3; }
        #api-urls-preview, #api-status-log {
            background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;
            padding: 1rem; margin-top: 1rem; font-family: monospace; white-space: pre-wrap;
            word-break: break-all; max-height: 200px; overflow-y: auto;
        }
        
        /* Component/Layout Gallery in Modal */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .gallery-item {
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            background-color: #f9fafb;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .gallery-item:hover {
            background-color: #f3f4f6;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
        }

        /* Tab Component Styles */
        .tls-tabs .tab-nav { list-style: none; padding: 0; margin: 0 0 -1px 0; display: flex; border-bottom: 1px solid #dee2e6; }
        .tls-tabs .tab-nav li { padding: 0.75rem 1.25rem; cursor: pointer; background-color: #e9ecef; border: 1px solid #dee2e6; border-bottom: none; border-radius: 0.25rem 0.25rem 0 0; margin-right: 0.25rem; position: relative; }
        .tls-tabs .tab-nav li.active { background-color: white; border-bottom: 1px solid white; }
        .tls-tabs .tab-content { border: 1px solid #dee2e6; padding: 1.5rem; border-radius: 0 0.25rem 0.25rem 0.25rem; }
        .tls-tabs .tab-pane { display: none; }
        .tls-tabs .tab-pane.active { display: block; }
        .tls-tabs .remove-tab-btn { background: none; border: none; color: #dc3545; cursor: pointer; position: absolute; top: 2px; right: 2px; font-weight: bold; }
        
        /* -- VANILLA QUILL TOOLBAR STYLES -- */
        .custom-toolbar-container {
            display: flex;
            align-items: center;
            position: absolute;
            top: 4px; left: 4px; right: 4px;
            z-index: 10;
        }
        .vanilla-toolbar-group {
            display: flex;
            align-items: center;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 2px;
            height: 32px;
            box-sizing: border-box;
        }
        .vanilla-toolbar-group button {
            background: none; border: none; padding: 4px; cursor: pointer;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
        }
        .vanilla-toolbar-group button:hover { background-color: #f0f0f0; }
        .vanilla-toolbar-group img { width: 18px; height: 18px; }
        
        .custom-dropdown-menu {
            display: none; position: absolute; top: 100%; left: 0;
            background: white; border: 1px solid #ccc; border-radius: 6px;
            padding: 4px; z-index: 11;
            min-width: 100px;
        }
        .custom-dropdown-container { position: relative; }
        .custom-dropdown-container.active .custom-dropdown-menu { display: flex; flex-direction: column; gap: 4px; }
        .custom-dropdown-menu input {
             border: 1px solid #ccc; border-radius: 4px; padding: 4px; width: 150px;
        }
        .custom-dropdown-menu button {
            background-color: #eee;
        }

        /* Generic Quill Editor Styles */
       .ql-container.ql-snow { border: 1px solid #ccc; }
       .ql-editor { min-height: 100px; }
       
       /* Saved Pages List Styling */
        #saved-pages-list { list-style: none; padding: 0; margin-top: 1rem; max-height: 40vh; overflow-y: auto; }
        #saved-pages-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
        #saved-pages-list li:last-child { border-bottom: none; }
        #saved-pages-list .page-info { cursor: pointer; }
        #saved-pages-list .page-info:hover { color: #0056b3; }
        #saved-pages-list .page-name { font-weight: 500; }
        #saved-pages-list .page-date { font-size: 0.8rem; color: #6c757d; }
        
        .color-picker-wrapper { position: relative; }
        .color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .ql-snow .ql-editor.ql-blank::before {
            left: 0;
            right: 0;
        }

    </style>
</head>
<body>

    <!-- Grid Layout Controls -->
    <div style="max-width: 1140px; margin: 0 auto 1rem auto; padding: 0.75rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: space-between;">
        <h3 style="font-size: 1.125rem; font-weight: 600; color: #1F2937;">Page Controls</h3>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button id="save-page-btn" class="modal-button" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Save</button>
            <button id="load-page-btn" class="modal-button" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Load</button>
            <select id="page-template-selector" style="border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                <option value="tisem">Tisem template</option>
                <option value="tls" selected>TLS Information Page</option>
            </select>
            <select id="grid-column-span-selector" style="border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                <optgroup label="8 Columns"><option value="8-left">Left Aligned</option><option value="8-center" selected>Centered</option><option value="8-right">Right Aligned</option></optgroup>
                <optgroup label="10 Columns"><option value="10-left">Left Aligned</option><option value="10-center">Centered</option><option value="10-right">Right Aligned</option></optgroup>
                <optgroup label="12 Columns"><option value="12-full">Full Width</option></optgroup>
            </select>
        </div>
    </div>

    <div id="main-content-area" style="max-width: 1140px; margin: auto; background-color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); border-radius: 0.5rem; padding: 2rem;">
        <div class="grid-row">
             <div id="left-gutter" class="col-md-2"></div>
             <div id="canvas-content-column" class="col-xs-12 col-md-8">
                <div id="canvas-content-wrapper">
                    <!-- Initial layout is built by initializeEditor() -->
                </div>
            </div>
             <div id="right-gutter" class="col-md-2"></div>
        </div>
    </div>
    
    <div style="max-width: 1140px; margin: 2rem auto; background-color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); border-radius: 0.5rem; padding: 2rem;">
        <!-- Canvas Upload Settings -->
        <div id="settings-section">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Canvas Upload Settings</h2>
            <div class="grid-row">
                <div class="col-xs-12 col-md-6" style="margin-bottom: 1rem;"><label for="course-id-input" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151;">Course ID</label><input type="text" id="course-id-input" placeholder="e.g., 21261" style="margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.375rem;"></div>
                <div class="col-xs-12 col-md-6" style="margin-bottom: 1rem;"><label for="page-name-input" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151;">Page Name</label><input type="text" id="page-name-input" placeholder="e.g., Making Decisions" style="margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.375rem;"></div>
            </div>
        </div>
        <!-- Action Buttons -->
        <div id="buttons-section" style="margin-top: 2rem; display: flex; justify-content: flex-end;"><button id="prepare-upload-btn" style="background-color: #2563EB; color: white; font-weight: 700; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer;">Upload to Canvas</button></div>
        <!-- Status -->
        <div id="status-section" style="margin-top: 2rem; border-top: 1px solid #E5E7EB; padding-top: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Connection Status</h2>
            <div style="display: flex; align-items: center; gap: 1rem; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem;"><p style="font-weight: 500;">Status: <span id="status-message" style="color: #333;">Initializing...</span></p><div id="loader" class="loader"></div></div>
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem;">Response</h2>
            <pre id="response-output" style="background-color: #1F2937; color: #F9FAFB; padding: 1rem; border-radius: 0.5rem; font-size: 0.875rem; white-space: pre-wrap; word-break: break-all; min-height: 50px;">Waiting for message...</pre>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="save-page-modal" class="modal-overlay">
         <div class="modal-content">
            <h3 style="margin-top: 0; font-size: 1.25rem; font-weight: 600;">Save Page</h3>
            <div>
                <label for="save-page-name-input" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151;">Page Name</label>
                <input type="text" id="save-page-name-input" placeholder="e.g., My First Template" style="margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.375rem;">
            </div>
            <div style="text-align: right; margin-top: 1rem;">
                <button id="confirm-save-page-btn" class="modal-button">Save</button>
                <button id="cancel-save-page-btn" class="modal-button" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="load-page-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top: 0; font-size: 1.25rem; font-weight: 600;">Load Page</h3>
            <ul id="saved-pages-list"></ul>
             <div style="text-align: right; margin-top: 1rem;">
                <button id="cancel-load-page-btn" class="modal-button" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="component-choice-modal" class="modal-overlay">
         <div class="modal-content">
            <h3 style="margin-top: 0; font-size: 1.25rem; font-weight: 600;">Add a Component</h3>
            <div id="component-gallery" class="gallery"></div>
            <div style="text-align: right; margin-top: 1rem;">
                <button id="cancel-component-modal-btn" class="modal-button" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="column-config-modal" class="modal-overlay">
         <div class="modal-content">
            <h3 style="margin-top: 0; font-size: 1.25rem; font-weight: 600;">Configure Row Layout</h3>
            <div>
                <label for="column-count-input" style="font-weight: 500; margin-right: 0.5rem;">Number of Columns:</label>
                <input type="number" id="column-count-input" value="1" min="1" max="12" style="width: 5rem; padding: 0.25rem; border: 1px solid #D1D5DB; border-radius: 0.25rem;">
            </div>
            <div id="column-widths-container" style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; background-color: #f9fafb; padding: 1rem; border-radius: 0.25rem;"></div>
            <p id="column-total-error" style="color: #DC2626; font-weight: 500; display: none; margin-top: 0.5rem;">Total column width cannot exceed 12.</p>
            <div style="text-align: right; margin-top: 1rem;">
                <button id="confirm-column-config-btn" class="modal-button">Create Layout</button>
                <button id="cancel-column-config-btn" class="modal-button" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>
     <div id="image-config-modal" class="modal-overlay">
         <div class="modal-content">
            <h3 style="margin-top: 0; font-size: 1.25rem; font-weight: 600;">Configure Image</h3>
            <div style="margin-top: 1rem;">
                <label for="image-height-input" style="font-weight: 500; margin-right: 0.5rem;">Image Height (in pixels):</label>
                <input type="number" id="image-height-input" placeholder="e.g., 400" min="50" style="width: 8rem; padding: 0.25rem; border: 1px solid #D1D5DB; border-radius: 0.25rem;">
            </div>
             <div style="margin-top: 1rem; display: flex; align-items: center;">
                <input type="checkbox" id="image-full-height-checkbox" style="margin-right: 0.5rem;">
                <label for="image-full-height-checkbox">Display full image (ignore height)</label>
            </div>
            <div style="text-align: right; margin-top: 1rem;">
                <button id="confirm-image-config-btn" class="modal-button">Create Image</button>
                <button id="cancel-image-config-btn" class="modal-button" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="api-confirmation-modal" class="modal-overlay">
         <div class="modal-content">
            <h3 style="margin-top: 0;">Confirm API Calls</h3>
            <pre id="api-urls-preview"></pre>
            <h4>Live Log</h4>
            <pre id="api-status-log">Waiting to start...</pre>
            <div style="text-align: right; margin-top: 1rem;">
                <button id="confirm-api-calls-btn" class="modal-button">OK, Proceed</button>
                <button id="cancel-api-calls-btn" class="modal-button" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="custom-confirm-modal" class="modal-overlay">
         <div class="modal-content">
            <h3 id="confirm-modal-title" style="margin-top: 0;">Confirmation</h3>
            <p id="confirm-modal-text">Are you sure?</p>
            <div style="text-align: right; margin-top: 1rem;">
                <button id="confirm-modal-ok-btn" class="modal-button">OK</button>
                <button id="confirm-modal-cancel-btn" class="modal-button" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">

    <script>
        // --- Global State ---
        let currentAddComponentTarget = null;
        let currentInsertAfter = null;
        let confirmCallback = null;
        let currentImageElement = null;
        let currentPageId = null;
        const quillInstances = new Map();
        
        // --- Supabase Client Initialization ---
        // REPLACE BOTH KEYS BELOW WITH YOUR OWN
        const SUPABASE_URL = 'secret';
        const SUPABASE_ANON_KEY = 'secret';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- Component Library ---
        const componentLibrary = {
            rowLayout: { name: 'Row Layout' },
            singleImage: { name: 'Image' },
            tlsTeam: {
                name: 'TLS Team Section',
                html: () => {
                     const uniqueId = `tabs-${Date.now()}`;
                     return `<div class="tls-tabs" data-tab-id="${uniqueId}">
                             <div data-toolbar-options="full" class="quill-editable"><h3>Meet the Team!</h3></div>
                             <ul class="tab-nav">
                                 <li class="active" data-tab-target="#${uniqueId}-1"><div data-toolbar-options="simple" class="quill-editable" data-placeholder="Team Member 1"></div><button class="remove-tab-btn">&times;</button></li>
                                 <li data-tab-target="#${uniqueId}-2"><div data-toolbar-options="simple" class="quill-editable" data-placeholder="Team Member 2"></div><button class="remove-tab-btn">&times;</button></li>
                             </ul>
                             <div class="tab-content">
                                 <div id="${uniqueId}-1" class="tab-pane active component-column"></div>
                                 <div id="${uniqueId}-2" class="tab-pane component-column"></div>
                             </div>
                             <div style="margin-top: 1rem;"><button class="add-tab-btn modal-button" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Add Member</button></div>
                        </div>`;
                }
            },
            cardsBlock: {
                name: 'Cards Block',
                html: () => `<div><div style="background-color: #F9FAFB; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #E5E7EB; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;"><div data-toolbar-options="simple" class="quill-editable"><h3>Cards Component</h3></div><div><label style="font-size: 0.875rem; font-weight: 500; color: #4B5563; margin-right: 0.5rem;">Set Columns:</label><input type="number" onchange="updateCardLayout(this)" value="3" min="1" max="6" style="border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.25rem 0.5rem; width: 5rem;"></div></div><div class="grid-row card-grid" style="margin-bottom: 2rem;"></div></div>`
            },
            mainTitle: {
                name: 'Main Title',
                html: () => `<div style="border-bottom: 2px solid #F59E0B; padding-bottom: 1rem; margin-bottom: 2rem;">
                                <div data-toolbar-options="title" class="quill-editable"><h1>Making decisions</h1></div>
                             </div>`
            },
            infoBlock: { 
                name: 'Info Block', 
                html: () => `<div style="background-color: #F9FAFB; padding: 1rem; border-radius: 0.5rem; border: 1px solid #E5E7EB; margin-bottom: 2rem;">
                                <div data-toolbar-options="full" class="quill-editable"><p><strong>Choose how you want to learn:</strong></p><ul><li>Work through this page and use the <a href="#" target="_blank">interactive exercise</a>.</li><li>Read The Ten Faces of Innovation by Tom Kelly.</li></ul></div>
                            </div>`
            },
            textBlock: { 
                name: 'Text Block', 
                html: () => `<div style="margin-bottom: 2rem; display: flex; align-items: flex-start;">
                                <div style="color: #374151; width: 100%;"><div data-toolbar-options="full" class="quill-editable"><p>Do you find yourself hesitating too long when faced with an important decision? Or do you choose quickly and later discover that your choice did not have the desired result? Making decisions is a skill you can develop. It is important to know that making decisions is not about speed. It is about thinking clearly, understanding your goals, and taking ownership of the outcome.</p></div></div>
                             </div>`
            },
            subTitle: { 
                name: 'Subtitle', 
                html: () => `<div style="border-bottom: 2px solid #E5E7EB; padding-bottom: 0.5rem; margin-bottom: 2rem;">
                                <div data-toolbar-options="full" class="quill-editable"><h2>Three Levels of Making Decisions</h2><p>This competence is divided into three levels. Discover what each level means and how they build on each other.</p></div>
                            </div>`
            },
            bulletBlock: { 
                name: 'Bulleted List', 
                html: () => `<div style="background-color: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
                                <div data-toolbar-options="full" class="quill-editable"><h2>How to develop Making Decisions</h2><ul><li>Use decision-making models. Try tools like a pros-and-cons list or a decision matrix to compare options objectively.</li><li>Clarify your goals first. Know what you want to achieve before choosing between options. This helps you make a better choice.</li></ul></div>
                            </div>`
            },
            conclusionBlock: { 
                name: 'Conclusion Block', 
                html: () => `<div style="background-color: #1E3A8A; color: white; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
                                <div data-toolbar-options="full" class="quill-editable"><h2>Conclusion</h2><p>Being able to make good decisions helps you stay focused, move forward with confidence, and sow the fruit of your success. This skill is valuable in your studies, your career, and your personal life.</p></div>
                            </div>`
            },
            resourcesBlock: { 
                name: 'Resources Block', 
                html: () => `<div style="border: 1px solid #D1D5DB; border-radius: 0.5rem; padding: 1.5rem;">
                                <div data-toolbar-options="full" class="quill-editable"><h2>Resources at TISEM & TiU</h2><ul><li>Follow a study choice or master's choice workshop: <a href="#" target="_blank">Trainings & workshops</a></li><li>Talk to a study advisor or an educational coordinator at Tisem: <a href="#" target="_blank">Contact</a></li></ul></div>
                            </div>`
            },
            card: {
                name: 'Card',
                html: (index = 1) => {
                    return `<div style="border: 1px solid #E5E7EB; border-radius: 0.5rem; padding: 1rem; background-color: white; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); height: 100%;">
                               <div data-toolbar-options="full" class="quill-editable"><h3>Level ${index}</h3><h4>Card Subtitle</h4><p>This is new placeholder text for your card.</p></div>
                               <img id="card-img-${Date.now()}-${index}" src="https://placehold.co/400x300/cccccc/ffffff?text=Click+to+Change" alt="Illustration" style="border-radius: 0.375rem; width: 100%; cursor: pointer;" onclick="promptForImageChange(this)">
                               <div data-toolbar-options="full" class="quill-editable"><p><strong>Example:</strong> Add a short description here.</p></div>
                           </div>`;
                }
            },
            tlsWelcome: {
                name: 'TLS Welcome',
                html: () => `<div class="tls-welcome-component" style="background-color: #194775; padding: 0.5rem 1rem;">
                                <div data-toolbar-options="welcome" class="quill-editable"><h2 style="color: white;">Welcome!</h2></div>
                             </div>`
            },
            tlsQuickLinks: {
                name: 'TLS Quick Links',
                html: () => `<div class="grid-row" style="margin-bottom: 2rem;">
                                <div class="col-xs-12 col-md-4" style="text-align: center;"><a href="#" class="quick-link-item" style="text-decoration: none; color: inherit;"><img src="https://placehold.co/160x160/cccccc/ffffff?text=MyTimetable" style="width: 100%; max-width: 160px; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;" onclick="promptForImageChange(this)"><div data-toolbar-options="simple" class="quill-editable"><h4>MyTimetable</h4></div></a></div>
                                <div class="col-xs-12 col-md-4" style="text-align: center;"><a href="#" class="quick-link-item" style="text-decoration: none; color: inherit;"><img src="https://placehold.co/160x160/cccccc/ffffff?text=Osiris" style="width: 100%; max-width: 160px; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;" onclick="promptForImageChange(this)"><div data-toolbar-options="simple" class="quill-editable"><h4>Osiris student</h4></div></a></div>
                                <div class="col-xs-12 col-md-4" style="text-align: center;"><a href="#" class="quick-link-item" style="text-decoration: none; color: inherit;"><img src="https://placehold.co/160x160/cccccc/ffffff?text=TEP+Profile" style="width: 100%; max-width: 160px; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;" onclick="promptForImageChange(this)"><div data-toolbar-options="simple" class="quill-editable"><h4>TEP Profile</h4></div></a></div>
                             </div>`
            },
            tlsButton: {
                name: 'TLS Button',
                html: () => `<div style="margin-bottom: 2rem;"><a href="#" style="display: block; background-color: #002B45; color: white; text-align: center; padding: 1rem; border-radius: 0.5rem; text-decoration: none; font-weight: bold;"><span data-toolbar-options="simple" class="quill-editable-inline">Book an Appointment</span></a></div>`
            },
            tlsTextBlockWithImage: {
                name: 'TLS Text w/ Image',
                html: () => `<div class="grid-row" style="margin-bottom: 2rem;">
                                <div class="col-md-8"><div data-toolbar-options="full" class="quill-editable"><h3>Visie op de opleiding</h3><p>Lorem ipsum dolor sit amet...</p></div></div>
                                <div class="col-md-4"><img src="https://placehold.co/160x160/cccccc/ffffff?text=Replace" style="width: 100%; max-width: 160px; border-radius: 0.5rem; cursor: pointer;" onclick="promptForImageChange(this)"></div>
                             </div>`
            },
            tlsNews: {
                name: 'TLS News Block',
                html: () => `<div><div data-toolbar-options="full" class="quill-editable"><h3>XXX Community News</h3><p>Lorem ipsum dolor sit amet...</p></div></div>`
            }
        };

        // --- Functions ---
        async function testEdgeFunction() {
            const statusMessageEl = document.getElementById('status-message');
            const responseOutputEl = document.getElementById('response-output');
            const loaderEl = document.getElementById('loader');
            statusMessageEl.textContent = 'Authenticating...';
            loaderEl.style.display = 'block';
            try {
                let { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    const { data, error } = await supabaseClient.auth.signInAnonymously();
                    if (error) throw error;
                    session = data.session;
                }
                if (!session) throw new Error("Authentication failed.");
                statusMessageEl.textContent = 'Contacting Supabase...';
                await loadPagesList(true);
                statusMessageEl.textContent = 'Connection OK.';
                statusMessageEl.style.color = '#10B981';
                responseOutputEl.textContent = 'Successfully connected and authenticated.';
            } catch (error) {
                statusMessageEl.textContent = 'Connection Failed.';
                statusMessageEl.style.color = '#EF4444';
                responseOutputEl.textContent = `An error occurred:\n${error.message}`;
                console.error('Error during initial connection:', error);
            } finally {
                loaderEl.style.display = 'none';
            }
        }
        
        function openComponentModal(targetContainer, insertAfter = null) {
            currentAddComponentTarget = targetContainer;
            currentInsertAfter = insertAfter;
            document.getElementById('component-choice-modal').style.display = 'flex';
        }
        
        function createAddComponentButton(targetContainer) {
            const addComponentArea = document.createElement('div');
            addComponentArea.className = 'add-component-area';
            addComponentArea.style.cssText = "margin-top: 1rem; border-top: 1px solid #E5E7EB; padding-top: 1rem; text-align: center;";
            const button = document.createElement('button');
            button.textContent = 'Add Component';
            button.style.cssText = "display: inline-flex; justify-content: center; border-radius: 0.375rem; border: 1px solid #D1D5DB; padding: 0.25rem 0.75rem; background-color: white; font-size: 0.75rem; font-weight: 500; color: #374151; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); cursor: pointer;";
            button.onclick = () => openComponentModal(targetContainer);
            addComponentArea.appendChild(button);
            targetContainer.appendChild(addComponentArea);
        }
        
        function createInlineAddButton(afterNode, targetContainer) {
            const inlineArea = document.createElement('div');
            inlineArea.className = 'inline-add-area';
            inlineArea.style.cssText = "margin: 0.5rem 0 1rem 0; border-top: 1px dashed #E5E7EB; padding-top: 0.75rem; text-align: center;";
            const btn = document.createElement('button');
            btn.textContent = 'Add Component';
            btn.style.cssText = "display: inline-flex; justify-content: center; border-radius: 0.375rem; border: 1px solid #D1D5DB; padding: 0.25rem 0.75rem; background-color: white; font-size: 0.75rem; font-weight: 500; color: #374151; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); cursor: pointer;";
            btn.onclick = () => openComponentModal(targetContainer, afterNode);
            inlineArea.appendChild(btn);
            afterNode.parentElement.insertBefore(inlineArea, afterNode.nextSibling);
        }

        function refreshInlineAddButtons(targetContainer) {
            if (!targetContainer) return;
            targetContainer.querySelectorAll(':scope > .inline-add-area, :scope > .add-component-area').forEach(el => el.remove());
            const childComponents = targetContainer.querySelectorAll(':scope > .component-wrapper');
            if (childComponents.length === 0) {
                createAddComponentButton(targetContainer);
            } else {
                childComponents.forEach(wrapper => createInlineAddButton(wrapper, targetContainer));
            }
        }
    
        function updateCardLayout(inputElement) {
            const columnCount = parseInt(inputElement.value, 10);
            const gridContainer = inputElement.closest('.component-wrapper').querySelector('.card-grid');
            if (!gridContainer) return;
            let colClass = `col-md-${Math.floor(12 / columnCount)}`;
            const currentCards = gridContainer.children.length;
            const diff = columnCount - currentCards;
            if (diff > 0) {
                for (let i = 0; i < diff; i++) {
                    const cardWrapper = document.createElement('div');
                    cardWrapper.innerHTML = componentLibrary.card.html(currentCards + i + 1);
                    gridContainer.appendChild(cardWrapper);
                    initializeAllQuillEditors(cardWrapper);
                }
            } else if (diff < 0) {
                for (let i = 0; i > diff; i--) {
                    if (gridContainer.lastElementChild) gridContainer.lastElementChild.remove();
                }
            }
            for (let card of gridContainer.children) card.className = `col-xs-12 ${colClass}`;
        }

        function addComponentControls(wrapper) {
            const controls = document.createElement('div');
            controls.className = 'component-controls';
            controls.innerHTML = `<button title="Move Up" class="move-up" style="padding:0.25rem; border-radius:0.25rem; cursor:pointer; border: none; background: none;"><svg style="width:1rem; height:1rem; color: #4B5563;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></button><button title="Move Down" class="move-down" style="padding:0.25rem; border-radius:0.25rem; cursor:pointer; border: none; background: none;"><svg style="width:1rem; height:1rem; color: #4B5563;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><button title="Delete" class="delete-component" style="padding:0.25rem; border-radius:0.25rem; cursor:pointer; border: none; background: none;"><svg style="width:1rem; height:1rem; color: #DC2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
            wrapper.insertBefore(controls, wrapper.firstChild);
            controls.querySelector('.move-up').addEventListener('click', () => {
                let prev = wrapper.previousElementSibling;
                while(prev && !prev.classList.contains('component-wrapper')) prev = prev.previousElementSibling;
                if (prev) wrapper.parentElement.insertBefore(wrapper, prev);
            });
            controls.querySelector('.move-down').addEventListener('click', () => {
                let next = wrapper.nextElementSibling;
                while(next && !next.classList.contains('component-wrapper')) next = next.nextElementSibling;
                if (next) wrapper.parentElement.insertBefore(next, wrapper);
            });
            controls.querySelector('.delete-component').addEventListener('click', () => {
                const parent = wrapper.parentElement;
                wrapper.remove();
                refreshInlineAddButtons(parent);
            });
        }
        
        function handleTeamTabs(wrapper) {
            const tabContainer = wrapper.querySelector('.tls-tabs'), nav = tabContainer.querySelector('.tab-nav'), content = tabContainer.querySelector('.tab-content'), addBtn = tabContainer.querySelector('.add-tab-btn');
            const switchTab = (li) => {
                if(!li) return;
                nav.querySelectorAll('li').forEach(el => el.classList.remove('active'));
                content.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
                li.classList.add('active');
                const targetPane = content.querySelector(li.dataset.tabTarget);
                if (targetPane) targetPane.classList.add('active');
            };
            nav.addEventListener('click', e => {
                const li = e.target.closest('li');
                if (li) {
                    if (e.target.classList.contains('remove-tab-btn')) {
                        content.querySelector(li.dataset.tabTarget)?.remove();
                        const prev = li.previousElementSibling, next = li.nextElementSibling;
                        li.remove();
                        switchTab(prev || next);
                    } else if (!e.target.closest('.ql-toolbar')) switchTab(li);
                }
            });
            addBtn.addEventListener('click', () => {
                const newId = `${tabContainer.dataset.tabId}-${Date.now()}`;
                const newLi = document.createElement('li');
                newLi.dataset.tabTarget = `#${newId}`;
                newLi.innerHTML = `<div data-toolbar-options="simple" class="quill-editable" data-placeholder="New Member"></div><button class="remove-tab-btn">&times;</button>`;
                nav.appendChild(newLi);
                const newPane = document.createElement('div');
                newPane.id = newId; newPane.className = 'tab-pane component-column';
                content.appendChild(newPane);
                initQuillOnElement(newLi.querySelector('.quill-editable'));
                refreshInlineAddButtons(newPane);
                switchTab(newLi);
            });
            if(nav.querySelector('li')) switchTab(nav.querySelector('li'));
        }

        function addNewComponent(typeKey, targetContainer, anIndex, insertAfterNode = null) {
            const componentData = componentLibrary[typeKey];
            if (!componentData || !targetContainer) return null;
            const wrapper = document.createElement('div');
            wrapper.className = 'component-wrapper';
            wrapper.dataset.componentType = typeKey;
            if(componentData.html) wrapper.innerHTML = componentData.html(anIndex);

            if (insertAfterNode && insertAfterNode.parentElement === targetContainer) targetContainer.insertBefore(wrapper, insertAfterNode.nextElementSibling);
            else {
                const addArea = targetContainer.querySelector(':scope > .add-component-area');
                if (addArea) targetContainer.insertBefore(wrapper, addArea);
                else targetContainer.appendChild(wrapper);
            }
            
            addComponentControls(wrapper);
            if (typeKey === 'cardsBlock') updateCardLayout(wrapper.querySelector('input[type="number"]'));
            else if (typeKey === 'tlsTeam') handleTeamTabs(wrapper);

            initializeAllQuillEditors(wrapper);
            refreshInlineAddButtons(targetContainer);
            return wrapper;
        }

        const pageTemplates = {
            tisem: (mainWrapper) => {
                mainWrapper.innerHTML = '';
                ['mainTitle', 'infoBlock', 'textBlock', 'subTitle', 'cardsBlock', 'bulletBlock', 'conclusionBlock', 'resourcesBlock'].forEach(key => addNewComponent(key, mainWrapper));
                const cardInput = mainWrapper.querySelector('[data-component-type="cardsBlock"] input[type="number"]');
                if(cardInput) { cardInput.value = '3'; updateCardLayout(cardInput); }
            },
            tls: (mainWrapper) => {
                mainWrapper.innerHTML = '';
                ['tlsWelcome', 'tlsQuickLinks', 'tlsButton', 'tlsTeam'].forEach(key => addNewComponent(key, mainWrapper));
                const rowWrapper = createCustomLayout(['8', '4'], mainWrapper);
                addNewComponent('tlsTextBlockWithImage', rowWrapper.querySelector('.col-md-8 .component-column'));
                const rightCol = rowWrapper.querySelector('.col-md-4 .component-column');
                addNewComponent('tlsNews', rightCol);
                addNewComponent('tlsNews', rightCol);
            }
        };

        function initializeEditor(templateKey = 'tls') {
            const mainWrapper = document.getElementById('canvas-content-wrapper');
            pageTemplates[templateKey](mainWrapper);
        }
        
        function populateComponentModal() {
            const gallery = document.getElementById('component-gallery');
            gallery.innerHTML = '';
            for (const key in componentLibrary) {
                if (key === 'card') continue;
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.textContent = componentLibrary[key].name;
                item.onclick = () => {
                    if (key === 'rowLayout') openColumnConfigModal(currentAddComponentTarget, currentInsertAfter);
                    else if (key === 'singleImage') openImageConfigModal(currentAddComponentTarget, currentInsertAfter);
                    else addNewComponent(key, currentAddComponentTarget, undefined, currentInsertAfter);
                    document.getElementById('component-choice-modal').style.display = 'none';
                };
                gallery.appendChild(item);
            }
        }
        
        function openColumnConfigModal(targetContainer, insertAfter = null) {
            currentAddComponentTarget = targetContainer; currentInsertAfter = insertAfter;
            document.getElementById('column-config-modal').style.display = 'flex';
            document.getElementById('column-count-input').value = 1;
            generateColumnWidthInputs();
        }

        function generateColumnWidthInputs() {
            const count = document.getElementById('column-count-input').value, container = document.getElementById('column-widths-container');
            container.innerHTML = '';
            if (count > 0) {
                const suggestedWidth = Math.floor(12 / count);
                let total = 0;
                for (let i = 0; i < count; i++) {
                    const width = (i === count - 1) ? (12 - total) : suggestedWidth, val = width > 0 ? width : 1;
                    container.innerHTML += `<input type="number" min="1" max="12" value="${val}" class="column-width-input" style="width: 4rem; padding: 0.25rem; border: 1px solid #D1D5DB; border-radius: 0.25rem;">`;
                    total += val;
                }
            }
            validateColumnWidths();
            container.querySelectorAll('.column-width-input').forEach(input => input.addEventListener('input', validateColumnWidths));
        }

        function validateColumnWidths() {
            let total = 0;
            document.querySelectorAll('#column-widths-container .column-width-input').forEach(input => { total += parseInt(input.value) || 0; });
            const errorEl = document.getElementById('column-total-error'), confirmBtn = document.getElementById('confirm-column-config-btn');
            const isValid = total <= 12;
            errorEl.style.display = isValid ? 'none' : 'block';
            if(!isValid) errorEl.textContent = `Total width is ${total}, but cannot exceed 12.`;
            confirmBtn.disabled = !isValid;
            confirmBtn.style.backgroundColor = isValid ? '#007bff' : '#6c757d';
            return isValid;
        }

        function createCustomLayout(widths, targetContainer, insertAfterNode = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'component-wrapper'; wrapper.dataset.componentType = 'rowLayout';
            const gridRow = document.createElement('div');
            gridRow.className = 'grid-row'; gridRow.style.cssText = "border: 2px dashed #ccc; padding: 1rem; background: #fcfcfc;";
            widths.forEach(width => {
                const colDiv = document.createElement('div');
                colDiv.className = `col-md-${width}`; colDiv.innerHTML = `<div class="component-column"></div>`;
                gridRow.appendChild(colDiv);
                refreshInlineAddButtons(colDiv.querySelector('.component-column'));
            });
            wrapper.appendChild(gridRow);
            if (insertAfterNode) targetContainer.insertBefore(wrapper, insertAfterNode.nextElementSibling);
            else targetContainer.appendChild(wrapper);
            addComponentControls(wrapper);
            refreshInlineAddButtons(targetContainer);
            return wrapper;
        }

        function createCustomLayoutFromModal() {
            if (!validateColumnWidths()) return;
            const widths = Array.from(document.querySelectorAll('#column-widths-container .column-width-input')).map(input => input.value);
            createCustomLayout(widths, currentAddComponentTarget, currentInsertAfter);
            document.getElementById('column-config-modal').style.display = 'none';
        }

        function openImageConfigModal(targetContainer, insertAfter = null) {
            currentAddComponentTarget = targetContainer; currentInsertAfter = insertAfter;
            document.getElementById('image-config-modal').style.display = 'flex';
            document.getElementById('image-height-input').value = '';
            document.getElementById('image-full-height-checkbox').checked = false;
            document.getElementById('image-height-input').disabled = false;
        }

        function createImageComponentFromModal() {
            const height = document.getElementById('image-full-height-checkbox').checked ? '' : document.getElementById('image-height-input').value;
            let style = 'width: 100%; max-width: 100%; border-radius: 0.5rem; cursor: pointer;';
            if (height) style += ` height: ${height}px; object-fit: cover;`;
            const wrapper = addNewComponent('singleImage', currentAddComponentTarget, undefined, currentInsertAfter);
            if (wrapper) wrapper.innerHTML = `<div style="text-align: center; margin-bottom: 2rem;"><img id="img-${Date.now()}" src="https://placehold.co/600x${height || 400}/cccccc/ffffff?text=Click+to+Change" alt="Placeholder" style="${style}" onclick="promptForImageChange(this)"></div>`;
            document.getElementById('image-config-modal').style.display = 'none';
        }

        function updateContentSpan() {
            const sel = document.getElementById('grid-column-span-selector').value, [span, align] = sel.split('-');
            document.getElementById('canvas-content-column').className = `col-xs-12 col-md-${span}`;
            const [left, right] = {'12-full':['',''], '10-left':['','col-md-2'], '10-center':['col-md-1','col-md-1'], '10-right':['col-md-2',''], '8-left':['','col-md-4'], '8-center':['col-md-2','col-md-2'], '8-right':['col-md-4','']}[sel];
            document.getElementById('left-gutter').className = left;
            document.getElementById('right-gutter').className = right;
        }
        
        function showConfirm(title, text, callback) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            confirmCallback = callback;
            document.getElementById('custom-confirm-modal').style.display = 'flex';
        }

        function promptForImageChange(element) {
            currentImageElement = element;
            if (!currentImageElement.id) currentImageElement.id = `img-${Date.now()}`;
            document.getElementById('image-upload-input').click();
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentImageElement) return;
            const statusMessageEl = document.getElementById('status-message'), responseOutputEl = document.getElementById('response-output'), loaderEl = document.getElementById('loader');
            const originalSrc = currentImageElement.src;
            currentImageElement.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
            loaderEl.style.display = 'block'; statusMessageEl.textContent = `Uploading ${file.name}...`;
            try {
                const filePath = `public/${Date.now()}-${file.name}`;
                const { error } = await supabaseClient.storage.from('page-images').upload(filePath, file);
                if (error) throw error;
                const { data } = supabaseClient.storage.from('page-images').getPublicUrl(filePath);
                if (!data.publicUrl) throw new Error('Could not get public URL.');
                currentImageElement.src = data.publicUrl;
                statusMessageEl.textContent = 'Image uploaded successfully!';
                responseOutputEl.textContent = `Image URL: ${data.publicUrl}`;
            } catch (error) {
                statusMessageEl.textContent = 'Image upload failed.'; statusMessageEl.style.color = '#EF4444';
                responseOutputEl.textContent = `Error: ${error.message}.`;
                currentImageElement.src = originalSrc;
            } finally {
                loaderEl.style.display = 'none';
                document.getElementById('image-upload-input').value = '';
                currentImageElement = null;
            }
        }
        
        // --- Page Save/Load Functions ---
        function serializeContainer(container) {
            const children = [];
            container.querySelectorAll(':scope > .component-wrapper').forEach(wrapper => {
                const componentType = wrapper.dataset.componentType;
                const componentData = { type: componentType, content: {} };
                if (componentType === 'rowLayout') {
                    componentData.content.columns = [];
                    wrapper.querySelectorAll(':scope > .grid-row > [class*="col-md-"]').forEach(colDiv => {
                        const colClass = Array.from(colDiv.classList).find(c => c.startsWith('col-md-'));
                        componentData.content.columns.push({
                            width: colClass.split('-')[2],
                            children: serializeContainer(colDiv.querySelector('.component-column'))
                        });
                    });
                } else {
                    const contentElement = wrapper.querySelector(':scope > :not(.component-controls)');
                    if (contentElement) componentData.content.html = contentElement.outerHTML;
                }
                children.push(componentData);
            });
            return children;
        }

        function deserializeContainer(container, contentArray) {
            container.innerHTML = '';
            quillInstances.clear();
            
            contentArray.forEach(componentData => {
                if (componentData.type === 'rowLayout') {
                    const layoutWrapper = createCustomLayout(componentData.content.columns.map(c => c.width), container);
                    componentData.content.columns.forEach((colData, index) => {
                        deserializeContainer(layoutWrapper.querySelectorAll('.component-column')[index], colData.children);
                    });
                } else {
                    const newComponent = addNewComponent(componentData.type, container);
                    if(newComponent){
                        const contentElement = newComponent.querySelector(':scope > :not(.component-controls)');
                        if (contentElement && componentData.content.html) contentElement.outerHTML = componentData.content.html;
                        initializeAllQuillEditors(newComponent);
                    }
                }
            });
            refreshInlineAddButtons(container);
        }

        async function savePage() {
            const pageName = document.getElementById('save-page-name-input').value;
            if (!pageName) { alert("Please provide a name for your page."); return; }
            const pageContent = serializeContainer(document.getElementById('canvas-content-wrapper'));
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { alert("Authentication session not found. Please refresh and try again."); return; }
            
            const loader = document.getElementById('loader'), statusMessage = document.getElementById('status-message'), responseOutput = document.getElementById('response-output');
            loader.style.display = 'block'; statusMessage.textContent = 'Saving page...'; statusMessage.style.color = '#333';
            
            try {
                const { data, error } = await supabaseClient.functions.invoke('page-handler', { method: 'POST', body: { name: pageName, content: pageContent, id: currentPageId } });
                if (error) throw error;
                currentPageId = data.id;
                statusMessage.textContent = 'Page saved successfully!'; statusMessage.style.color = '#10B981';
                responseOutput.textContent = `Saved "${data.name}" (ID: ${data.id})`;
                document.getElementById('save-page-modal').style.display = 'none';
            } catch (err) {
                statusMessage.textContent = 'Error saving page.'; statusMessage.style.color = '#EF4444';
                responseOutput.textContent = `Error: ${err.message}`;
                console.error("Save failed:", err);
            } finally { loader.style.display = 'none'; }
        }
        
        async function loadPagesList(silent = false) {
             const { data, error } = await supabaseClient.functions.invoke('page-handler', { method: 'GET' });
             if (error) {
                if(!silent) document.getElementById('response-output').textContent = `Error loading pages: ${error.message}`;
                throw error;
             }
             if(silent) return;
             const listEl = document.getElementById('saved-pages-list');
             listEl.innerHTML = '';
             if (data && data.length > 0) {
                 data.forEach(page => {
                     const li = document.createElement('li');
                     li.innerHTML = `<div class="page-info" onclick="loadPageContent(${page.id})"><div class="page-name">${page.name}</div><div class="page-date">Last updated: ${new Date(page.updated_at).toLocaleString()}</div></div><button onclick="deletePage(${page.id})" style="background:none; border:none; cursor:pointer; color:#dc3545;">&times;</button>`;
                     listEl.appendChild(li);
                 });
             } else listEl.innerHTML = '<li>No saved pages found.</li>';
             document.getElementById('load-page-modal').style.display = 'flex';
        }

        async function loadPageContent(pageId) {
            document.getElementById('loader').style.display = 'block'; document.getElementById('status-message').textContent = 'Loading page...';
            try {
                const { data, error } = await supabaseClient.functions.invoke(`page-handler?id=${pageId}`, { method: 'GET' });
                if (error) throw error;
                currentPageId = data.id;
                document.getElementById('save-page-name-input').value = data.name; document.getElementById('page-name-input').value = data.name;
                deserializeContainer(document.getElementById('canvas-content-wrapper'), data.content);
                document.getElementById('status-message').textContent = 'Page loaded successfully!';
                document.getElementById('load-page-modal').style.display = 'none';
            } catch(err) {
                 document.getElementById('status-message').textContent = 'Error loading page.'; document.getElementById('response-output').textContent = err.message;
            } finally { document.getElementById('loader').style.display = 'none'; }
        }
        
        async function deletePage(pageId) {
             showConfirm('Delete Page?', 'This action cannot be undone. Are you sure you want to delete this page?', async () => {
                document.getElementById('loader').style.display = 'block'; document.getElementById('status-message').textContent = 'Deleting page...';
                try {
                     const { error } = await supabaseClient.functions.invoke('page-handler', { method: 'DELETE', body: { id: pageId } });
                     if (error) throw error;
                     document.getElementById('status-message').textContent = 'Page deleted.';
                     if (currentPageId === pageId) { currentPageId = null; document.getElementById('save-page-name-input').value = ''; }
                     loadPagesList();
                } catch(err) {
                    document.getElementById('status-message').textContent = 'Error deleting page.'; document.getElementById('response-output').textContent = err.message;
                } finally { document.getElementById('loader').style.display = 'none'; }
             });
        }
        
        function changeComponentColor(inputElement) {
            const wrapper = inputElement.closest('.component-wrapper');
            const welcomeComponent = wrapper?.querySelector('.tls-welcome-component');
            if(welcomeComponent) {
                welcomeComponent.style.backgroundColor = inputElement.value;
            }
        }

        async function uploadToCanvas() { 
            const courseId = document.getElementById('course-id-input').value, pageTitle = document.getElementById('page-name-input').value;
            const logEl = document.getElementById('api-status-log'), statusMessageEl = document.getElementById('status-message'), responseOutputEl = document.getElementById('response-output'), loaderEl = document.getElementById('loader');
            loaderEl.style.display = 'block'; logEl.textContent = 'Starting process...\n';
            try {
                statusMessageEl.textContent = 'Finalizing page content...'; logEl.textContent += 'Preparing HTML for Canvas...\n';
                const contentClone = document.getElementById('canvas-content-wrapper').cloneNode(true);
                
                contentClone.querySelectorAll('.custom-toolbar-container, .ql-tooltip, .component-controls, .add-component-area, .inline-add-area, .add-tab-btn, .remove-tab-btn').forEach(el => el.remove());
                contentClone.querySelectorAll('[onclick]').forEach(el => el.removeAttribute('onclick'));
                contentClone.querySelectorAll('[contenteditable]').forEach(el => el.removeAttribute('contenteditable'));
                contentClone.querySelectorAll('.ql-editor').forEach(el => {
                    const parent = el.parentElement;
                    if(parent.classList.contains('quill-editable')){
                        parent.outerHTML = parent.innerHTML;
                    }
                });
                
                let componentHtml = '';
                contentClone.querySelectorAll(':scope > .component-wrapper').forEach(wrapper => {
                    const content = wrapper.querySelector(':scope > :not(.component-controls)');
                    if(content) componentHtml += content.outerHTML;
                });
                if (!componentHtml.trim()) throw new Error("Page content is empty.");

                const finalHtml = `<div class="grid-row"><div class="${document.getElementById('left-gutter').className}">&nbsp;</div><div class="${document.getElementById('canvas-content-column').className}">${componentHtml}</div><div class="${document.getElementById('right-gutter').className}">&nbsp;</div></div>`;
                const { data, error } = await supabaseClient.functions.invoke('create-canvas-page-from-html', { body: { courseId, pageTitle, htmlContent: finalHtml } });
                if (error) throw error;
                statusMessageEl.textContent = 'Successfully uploaded to Canvas!'; statusMessageEl.style.color = '#10B981';
                responseOutputEl.textContent = `Page created successfully! View it at: ${data.pageUrl}`;
                logEl.textContent += `Page created successfully!`;
            } catch (error) {
                statusMessageEl.textContent = 'An error occurred during upload.'; statusMessageEl.style.color = '#EF4444';
                responseOutputEl.textContent = `Error: ${error.message}`;
            } finally {
                loaderEl.style.display = 'none';
                document.getElementById('api-confirmation-modal').style.display = 'none';
            }
         }
        
        function prepareAndConfirmUpload() {
             const courseId = document.getElementById('course-id-input').value, pageTitle = document.getElementById('page-name-input').value;
             if (!courseId || !pageTitle) { showConfirm("Missing Information", "Please fill in the Course ID and Page Name.", ()=>{}); return; }
             document.getElementById('api-urls-preview').textContent = `Course ID: ${courseId}\nPage Name: ${pageTitle}\n\nFunction URL:\n${SUPABASE_URL}/functions/v1/create-canvas-page-from-html`;
             document.getElementById('api-status-log').textContent = 'Ready to proceed.';
             document.getElementById('api-confirmation-modal').style.display = 'flex';
        }
        
        function initQuillOnElement(element) {
            if (element.dataset.quillInitialized || !element.parentElement) return;
            if (!element.id) element.id = `quill-editor-${Math.random().toString(36).substring(2, 11)}`;

            const quill = new Quill(element, { theme: 'snow', modules: { toolbar: false } });
            quillInstances.set(element.id, quill);
            element.dataset.quillInitialized = 'true';

            const wrapper = element.closest('.component-wrapper');
            if (!wrapper) return;

            const toolbarContainer = document.createElement('div');
            toolbarContainer.className = 'custom-toolbar-container';

            const toolbarGroup = document.createElement('div');
            toolbarGroup.className = 'vanilla-toolbar-group';

            const icons = {
                'bold': 'https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/boldformat.png',
                'italic': 'https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/italicformat.png',
                'align': 'https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/aligntext.png',
                'color': 'https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/textcolor.png',
                'link': 'https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/urllinks.png',
                'size': 'https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/fontsize.png',
                'list': 'https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/lists.png',
                'background': 'https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/shapecoloricon.png'
            };

            const toolbarOptionsKey = element.dataset.toolbarOptions || 'full';
            const toolsets = {
                'simple': ['bold', 'italic', 'link'],
                'title': ['bold', 'italic'],
                'welcome': ['bold', 'italic', 'color', 'align', 'link', 'size', 'background'],
                'full': ['bold', 'italic', 'color', 'align', 'link', 'size', 'list', 'background']
            };
            const currentTools = toolsets[toolbarOptionsKey] || toolsets['full'];

            currentTools.forEach(tool => {
                if (tool === 'align' || tool === 'link' || tool === 'color' || tool === 'size' || tool === 'list') {
                     const dropdownContainer = document.createElement('div');
                    dropdownContainer.className = 'custom-dropdown-container';
                    dropdownContainer.innerHTML = `<button data-dropdown="${tool}"><img src="${icons[tool]}" alt="${tool}"></button>`;
                    const menu = document.createElement('div');
                    menu.className = 'custom-dropdown-menu';
                    
                    if(tool === 'align') menu.innerHTML = `<button data-align="left">Left</button><button data-align="center">Center</button><button data-align="right">Right</button>`;
                    if(tool === 'link') menu.innerHTML = `<input type="text" placeholder="https://example.com"><button>Apply</button>`;
                    if(tool === 'color') menu.innerHTML = `<input type="color" value="#000000">`;
                    if(tool === 'size') menu.innerHTML = `<button data-size="small">Small</button><button data-size="false">Normal</button><button data-size="large">Large</button><button data-size="huge">Huge</button>`;
                    if(tool === 'list') menu.innerHTML = `<button data-list="bullet"><img src="https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/bullets.png" style="width:18px;height:18px;" alt="Bullet"></button><button data-list="ordered"><img src="https://ttzakubulphvibneblpm.supabase.co/storage/v1/object/public/TiU/lists.png" style="width:18px;height:18px;" alt="Ordered"></button>`;

                    dropdownContainer.appendChild(menu);
                    toolbarGroup.appendChild(dropdownContainer);
                } else if(tool === 'background') {
                     const colorPicker = document.createElement('div');
                     colorPicker.className = 'custom-dropdown-container color-picker-wrapper';
                     colorPicker.innerHTML = `<input type="color" class="color-picker-input" onchange="changeComponentColor(this)"><img src="${icons.background}" alt="BG Color">`;
                     toolbarGroup.appendChild(colorPicker);
                }
                else {
                    toolbarGroup.innerHTML += `<button data-format="${tool}"><img src="${icons[tool]}" alt="${tool}"></button>`;
                }
            });
            
            toolbarContainer.appendChild(toolbarGroup);
            wrapper.insertBefore(toolbarContainer, wrapper.firstChild);

            toolbarContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.dataset.format) quill.format(button.dataset.format, !quill.getFormat()[button.dataset.format]);
                if (button.dataset.dropdown) {
                    const currentDropdown = button.parentElement;
                    const wasActive = currentDropdown.classList.contains('active');
                    e.currentTarget.querySelectorAll('.custom-dropdown-container').forEach(c => c.classList.remove('active'));
                    if(!wasActive) currentDropdown.classList.add('active');
                }
                if (button.dataset.align) quill.format('align', button.dataset.align === 'left' ? false : button.dataset.align);
                if (button.dataset.size) quill.format('size', button.dataset.size === 'false' ? false : button.dataset.size);
                if (button.dataset.list) quill.format('list', quill.getFormat().list === button.dataset.list ? false : button.dataset.list);
                if (button.parentElement.querySelector('input[type="text"]')) {
                    const input = button.parentElement.querySelector('input[type="text"]');
                    quill.format('link', input.value);
                }
                 if(button.closest('.custom-dropdown-menu')) button.closest('.custom-dropdown-container').classList.remove('active');
            });
            toolbarContainer.querySelector('input[type="color"]')?.addEventListener('input', (e) => {
                 quill.format('color', e.target.value);
            });
        }
        
        function initializeAllQuillEditors(container) {
            container.querySelectorAll('.quill-editable, .quill-editable-inline').forEach(initQuillOnElement);
        }

        document.addEventListener('DOMContentLoaded', () => {
            testEdgeFunction();
            initializeEditor();
            populateComponentModal();
            
            document.getElementById('column-count-input').addEventListener('input', generateColumnWidthInputs);
            document.getElementById('confirm-column-config-btn').addEventListener('click', createCustomLayoutFromModal);
            document.getElementById('cancel-column-config-btn').addEventListener('click', () => document.getElementById('column-config-modal').style.display = 'none');
            document.getElementById('confirm-image-config-btn').addEventListener('click', createImageComponentFromModal);
            document.getElementById('cancel-image-config-btn').addEventListener('click', () => document.getElementById('image-config-modal').style.display = 'none');
            document.getElementById('image-full-height-checkbox').addEventListener('change', (e) => document.getElementById('image-height-input').disabled = e.target.checked);
            document.getElementById('grid-column-span-selector').addEventListener('change', updateContentSpan);
            document.getElementById('page-template-selector').addEventListener('change', (e) => {
                 showConfirm( 'Change Template?', 'This will clear the current page. Are you sure?', () => initializeEditor(e.target.value) );
            });
            document.getElementById('prepare-upload-btn').addEventListener('click', prepareAndConfirmUpload);
            document.getElementById('confirm-api-calls-btn').addEventListener('click', uploadToCanvas);
            document.getElementById('cancel-api-calls-btn').addEventListener('click', () => document.getElementById('api-confirmation-modal').style.display = 'none');
            document.getElementById('cancel-component-modal-btn').addEventListener('click', () => document.getElementById('component-choice-modal').style.display = 'none');
            document.getElementById('confirm-modal-ok-btn').addEventListener('click', async () => { 
                if (confirmCallback) await confirmCallback(); 
                confirmCallback = null; 
                document.getElementById('custom-confirm-modal').style.display = 'none'; 
            });
            document.getElementById('confirm-modal-cancel-btn').addEventListener('click', () => { 
                confirmCallback = null; 
                document.getElementById('custom-confirm-modal').style.display = 'none'; 
            });
            document.getElementById('image-upload-input').addEventListener('change', handleImageUpload);

            // Save/Load Modal events
            document.getElementById('save-page-btn').addEventListener('click', () => {
                document.getElementById('save-page-name-input').value = document.getElementById('page-name-input').value || '';
                document.getElementById('save-page-modal').style.display = 'flex';
            });
            document.getElementById('load-page-btn').addEventListener('click', () => loadPagesList());
            document.getElementById('confirm-save-page-btn').addEventListener('click', savePage);
            document.getElementById('cancel-save-page-btn').addEventListener('click', () => document.getElementById('save-page-modal').style.display = 'none');
            document.getElementById('cancel-load-page-btn').addEventListener('click', () => document.getElementById('load-page-modal').style.display = 'none');
        });
    </script>
</body>
</html>


